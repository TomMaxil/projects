@{
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}
@model Purchase

<div class="main-content">
    <div class="content-wrapper">
        <div class="page-header">
            <h1>Purchase Invoice</h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-controller="Admin" asp-action="Index">Dashboard</a></li>
                    <li class="breadcrumb-item"><a asp-controller="Purchase" asp-action="Index">Purchases</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Invoice #@Model.PurchaseId</li>
                </ol>
            </nav>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card invoice-card">
                    <!-- Invoice Header -->
                    <div class="card-header bg-dark text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0">PURCHASE INVOICE</h4>
                                <small class="opacity-75">Purchase ID: PUR-@Model.PurchaseId.ToString("D4")</small>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-success fs-6 p-2">PAID</span>
                            </div>
                        </div>
                    </div>

                    <div class="card-body" id="invoiceContent">
                        <!-- Invoice Information -->
                        <div class="invoice-info mb-5">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="company-details">
                                        <h5 class="text-primary mb-3">Company Information</h5>
                                        <p class="mb-1"><strong>Your Company Name</strong></p>
                                        <p class="mb-1">123 Business Street</p>
                                        <p class="mb-1">City, State 12345</p>
                                        <p class="mb-1">Phone: (123) 456-7890</p>
                                        <p class="mb-0">Email: info@yourcompany.com</p>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="invoice-details text-md-end">
                                        <h5 class="text-primary mb-3">Invoice Details</h5>
                                        <table class="table table-borderless table-sm">
                                            <tr>
                                                <td class="text-muted">Invoice #:</td>
                                                <td class="text-end"><strong>PUR-@Model.PurchaseId.ToString("D4")</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Date:</td>
                                                <td class="text-end"><strong>@Model.PurchaseDate.ToString("dd MMMM yyyy")</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Time:</td>
                                                <td class="text-end"><strong>@Model.PurchaseDate.ToString("hh:mm tt")</strong></td>
                                            </tr>
                                            <tr>
                                                <td class="text-muted">Status:</td>
                                                <td class="text-end"><span class="badge bg-success">Completed</span></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <div class="invoice-items mb-5">
                            <div class="table-responsive">
                                <table class="table table-bordered invoice-table" id="purchaseItemsTable">
                                    <thead class="thead-dark">
                                        <tr>
                                            <th width="5%">#</th>
                                            <th width="45%">Product Description</th>
                                            <th width="15%" class="text-center">Quantity</th>
                                            <th width="15%" class="text-end">Unit Price</th>
                                            <th width="20%" class="text-end">Line Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @{
                                            int counter = 1;
                                            decimal grandTotal = 0;
                                        }
                                        @foreach (var item in Model.PurchaseItems)
                                        {
                                            var lineTotal = item.Quantity * item.CostPrice;
                                            grandTotal += lineTotal;
                                            <tr>
                                                <td>@counter</td>
                                                <td>
                                                    <div class="product-info">
                                                        <h6 class="mb-1">@item.Product.Name</h6>
                                                        <small class="text-muted">Product Code: PROD-@item.Product.ProductId</small>
                                                    </div>
                                                </td>
                                                <td class="text-center">
                                                    <span class="quantity-badge">@item.Quantity</span>
                                                </td>
                                                <td class="text-end">$@item.CostPrice.ToString("N2")</td>
                                                <td class="text-end">$@lineTotal.ToString("N2")</td>
                                            </tr>
                                            counter++;
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Totals -->
                        <div class="invoice-totals">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="invoice-notes">
                                        <h6 class="text-primary mb-2">Notes</h6>
                                        <p class="text-muted mb-0">Thank you for your business. All items purchased are non-refundable.</p>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <table class="table table-bordered total-table">
                                        <tr>
                                            <td class="text-muted">Subtotal:</td>
                                            <td class="text-end">$@grandTotal.ToString("N2")</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Tax (0%):</td>
                                            <td class="text-end">$0.00</td>
                                        </tr>
                                        <tr>
                                            <td class="text-muted">Shipping:</td>
                                            <td class="text-end">$0.00</td>
                                        </tr>
                                        <tr class="total-row">
                                            <td class="text-primary"><strong>GRAND TOTAL:</strong></td>
                                            <td class="text-end text-primary"><strong>$@Model.TotalAmount.ToString("N2")</strong></td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Footer -->
                        <div class="invoice-footer mt-5 pt-4 border-top">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6 class="text-primary mb-2">Payment Information</h6>
                                    <p class="mb-1">Payment Method: <strong>Bank Transfer</strong></p>
                                    <p class="mb-1">Account: <strong>XXXX-XXXX-XXXX-1234</strong></p>
                                    <p class="mb-0">Due Date: <strong>@Model.PurchaseDate.ToString("dd MMM yyyy")</strong></p>
                                </div>
                                <div class="col-md-6 text-md-end">
                                    <h6 class="text-primary mb-2">Authorized Signature</h6>
                                    <div class="signature-space mt-3">
                                        <p class="border-top pt-2 mb-0">_________________________</p>
                                        <small class="text-muted">Authorized Person</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card-footer">
                        <div class="d-flex justify-content-between">
                            <div>
                                <a asp-action="Index" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left"></i> Back to Purchases
                                </a>
                            </div>
                            <div class="btn-group">
                                <button onclick="downloadPDF()" class="btn btn-outline-primary">
                                    <i class="fas fa-download"></i> Download PDF
                                </button>
                                <button onclick="printInvoice()" class="btn btn-outline-primary">
                                    <i class="fas fa-print"></i> Print Invoice
                                </button>
                                <a asp-action="Edit" asp-route-id="@Model.PurchaseId" class="btn btn-outline-info">
                                    <i class="fas fa-edit"></i> Edit
                                </a>
                                <a asp-action="Delete" asp-route-id="@Model.PurchaseId"
                                   class="btn btn-outline-danger"
                                   onclick="return confirm('Are you sure you want to delete this purchase?');">
                                    <i class="fas fa-trash"></i> Delete
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<style>
    .main-content {
        margin-left: 250px;
        padding: 30px;
        min-height: 100vh;
        background: #f5f7fa;
    }

    .content-wrapper {
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e3e6f0;
    }

    .page-header h1 {
        color: #2c3e50;
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 28px;
    }

    .breadcrumb {
        background: transparent;
        padding: 0;
        margin-bottom: 0;
    }

    .breadcrumb-item a {
        color: #6c757d;
        text-decoration: none;
    }

    .breadcrumb-item.active {
        color: #2c3e50;
        font-weight: 500;
    }

    .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
        color: #6c757d;
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        background: white;
        margin-bottom: 30px;
    }

    .invoice-card {
        border: 2px solid #e3e6f0;
    }

    .card-header.bg-dark {
        background: #2c3e50 !important;
        border-radius: 10px 10px 0 0 !important;
        padding: 20px 30px;
    }

    .card-body {
        padding: 30px;
    }

    .card-footer {
        background: #f8f9fa;
        border-top: 1px solid #e3e6f0;
        padding: 20px 30px;
        border-radius: 0 0 10px 10px;
    }

    .invoice-info {
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e3e6f0;
    }

    .invoice-table {
        border: 1px solid #dee2e6;
    }

    .invoice-table thead.thead-dark th {
        background: #2c3e50;
        color: white;
        border-bottom: 2px solid #1a252f;
        padding: 15px;
        font-weight: 600;
    }

    .invoice-table tbody td {
        padding: 15px;
        vertical-align: middle;
        border-bottom: 1px solid #e3e6f0;
    }

    .invoice-table tbody tr:hover {
        background-color: rgba(44, 62, 80, 0.03);
    }

    .total-table {
        border: 1px solid #dee2e6;
    }

    .total-table td {
        padding: 10px 15px;
        border-bottom: 1px solid #e3e6f0;
    }

    .total-table .total-row {
        background: #2c3e50;
        color: white;
    }

    .total-table .total-row td {
        border-bottom: none;
        font-size: 16px;
        padding: 12px 15px;
    }

    .quantity-badge {
        display: inline-block;
        background: #e3f2fd;
        color: #1976d2;
        padding: 4px 12px;
        border-radius: 20px;
        font-weight: 600;
        min-width: 40px;
    }

    .badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-weight: 600;
    }

    .bg-success {
        background: #28a745 !important;
    }

    .text-primary {
        color: #2c3e50 !important;
    }

    .text-muted {
        color: #6c757d !important;
    }

    .border-top {
        border-top: 1px solid #e3e6f0 !important;
    }

    .btn {
        padding: 10px 20px;
        border-radius: 5px;
        font-weight: 500;
        transition: all 0.3s;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #d1d3e2;
    }

    .btn-outline-secondary:hover {
        background: #f8f9fa;
        color: #2c3e50;
        border-color: #2c3e50;
    }

    .btn-outline-primary {
        background: transparent;
        color: #2c3e50;
        border: 1px solid #2c3e50;
    }

    .btn-outline-primary:hover {
        background: #2c3e50;
        color: white;
    }

    .btn-outline-info {
        background: transparent;
        color: #17a2b8;
        border: 1px solid #17a2b8;
    }

    .btn-outline-info:hover {
        background: #17a2b8;
        color: white;
    }

    .btn-outline-danger {
        background: transparent;
        color: #e74c3c;
        border: 1px solid #e74c3c;
    }

    .btn-outline-danger:hover {
        background: #e74c3c;
        color: white;
    }

    .btn-group {
        gap: 10px;
    }

    .signature-space {
        max-width: 300px;
        margin-left: auto;
    }

 
    @@media print {
        .main-content {
            margin-left: 0;
            padding: 0;
            background: white;
        }
        
        .page-header,
        .breadcrumb,
        .card-footer,
        .btn {
            display: none !important;
        }
        
        .card {
            box-shadow: none;
            border: none;
            margin: 0;
        }
        
        .invoice-card {
            border: none;
        }
        
        .card-body {
            padding: 20px;
        }
        
      
        .invoice-table {
            page-break-inside: avoid;
        }
        
        .total-table {
            page-break-inside: avoid;
        }
      
        .card-header.bg-dark {
            background: #2c3e50 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .total-table .total-row {
            background: #2c3e50 !important;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
       
        .quantity-badge {
            background: transparent;
            border: 1px solid #1976d2;
        }
       
        @@page {
            margin: 20mm;
        }
        
        body {
            margin: 0;
            padding: 0;
        }
    }

    @@media (max-width: 768px) {
        .main-content {
            margin-left: 0;
            padding: 20px;
        }

        .invoice-info .row,
        .invoice-totals .row,
        .invoice-footer .row {
            flex-direction: column;
            gap: 20px;
        }

        .card-footer .d-flex {
            flex-direction: column;
            gap: 15px;
        }

        .btn-group {
            flex-direction: column;
            width: 100%;
        }

        .btn-group .btn {
            width: 100%;
            justify-content: center;
        }

        .text-md-end {
            text-align: left !important;
        }

        .signature-space {
            margin-left: 0;
        }
    }
</style>

<script>
    async function downloadPDF() {
        try {
            const originalText = event.target.innerHTML;
            event.target.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating PDF...';
            event.target.disabled = true;

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const element = document.getElementById('invoiceContent');

            const originalBackground = element.style.backgroundColor;
            element.style.backgroundColor = 'white';

            const canvas = await html2canvas(element, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff'
            });

            element.style.backgroundColor = originalBackground;

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = 190;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            doc.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);

            const pageHeight = doc.internal.pageSize.getHeight();
            const totalPages = doc.internal.getNumberOfPages();

            for (let i = 1; i <= totalPages; i++) {
                doc.setPage(i);
                doc.setFontSize(10);
                doc.setTextColor(128);
                doc.text(`Page ${i} of ${totalPages}`, 105, pageHeight - 10, { align: 'center' });
            }

            doc.save(`Purchase-Invoice-PUR-@Model.PurchaseId.ToString("D4")-${new Date().getTime()}.pdf`);

        } catch (error) {
            console.error('Error generating PDF:', error);
            alert('Error generating PDF. Please try again.');
        } finally {
            if (event.target) {
                event.target.innerHTML = '<i class="fas fa-download"></i> Download PDF';
                event.target.disabled = false;
            }
        }
    }

    function printInvoice() {
        window.print();
    }
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">